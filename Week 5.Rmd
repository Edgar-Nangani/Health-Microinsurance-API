# ================================
# WEEK 5: Pricing with GLMs
# ================================


```{python}
import os
import pandas as pd
import statsmodels.api as sm
import statsmodels.formula.api as smf
import matplotlib.pyplot as plt
import seaborn as sns
```
```{python}
# Step 1: Load Week 4 Data
data_path = "C:/Users/HP/Desktop/Python Project/data/processed/ExpectedClaims.csv"
if not os.path.exists(data_path):
    raise FileNotFoundError("❌ ExpectedClaims.csv not found. Please complete Week 4 first.")

data = pd.read_csv(data_path)
print("✅ Week 4 data loaded successfully!")
```

```{python}
# Step 2: Prepare data
data["Gender"] = data["Gender"].astype("category")
data["Region"] = data["Region"].astype("category")
```

```{python}
# Step 3: Build Pricing Model (GLM)
# Premium = expected claim adjusted for risk factors
pricing_model = smf.glm(
    formula="Expected_Claim ~ Age + Gender + Region",
    data=data,
    family=smf.families.Gaussian()
).fit()

print("\n✅ Pricing Model Summary:")
print(pricing_model.summary())
```

```{python}
# Step 4: Predict premiums
data["Predicted_Premium"] = pricing_model.predict()
# Optional: Ensure premiums are not negative
data["Predicted_Premium"] = data["Predicted_Premium"].clip(lower=0)
```

```{python}
# Step 5: Save results
os.makedirs("data/pricing", exist_ok=True)
data.to_csv("C:/Users/HP/Desktop/Python Project/data/pricing/Pricing_Model_Output.csv", index=False)
```

```{python}
# Save model summary (Python doesn't save model objects like RData by default)
with open("C:/Users/HP/Desktop/Python Project/reports/Week5_Pricing_Model_Summary.txt", "w") as f:
    f.write(pricing_model.summary().as_text())

print("Picing model outputs saved:")
print(" - data/pricing/Pricing_Model_Output.csv")
print(" - models/Week5_Pricing_Model_Summary.txt")
```





```{python}
# Step 6: Visualize Premium Distribution
os.makedirs("reports", exist_ok=True)

plt.figure(figsize=(6, 4))
sns.histplot(data["Predicted_Premium"], bins=15, color="steelblue", edgecolor="black")
plt.title("Predicted Premium Distribution")
plt.xlabel("Premium (UGX)")
plt.ylabel("Frequency")
plt.tight_layout()
plt.show()
plt.savefig("C:/Users/HP/Desktop/Python Project/reports/Week5_Premium_Distribution.png")
plt.close()
```

```{python}
# Step 7: Generate Report
report_text = f"""
WEEK 5: PRICING MODEL REPORT
===========================

GLM Pricing Model Summary:
{pricing_model.summary().as_text()}

Outputs:
- data/pricing/Pricing_Model_Output.csv
- models/Week5_Pricing_Model_Summary.txt
- reports/Week5_Premium_Distribution.png
"""

with open("C:/Users/HP/Desktop/Python Project/reports/Week5_Pricing_Report.txt", "w") as f:
    f.write(report_text)

print("\n Week 5 completed successfully! Report saved to reports/Week5_Pricing_Report.txt")

```


