# ================================
# WEEK 6: Modern Pricing with XGBoost
# ================================
```{python}
import os
import pandas as pd
import numpy as np
import xgboost as xgb
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.metrics import mean_absolute_error, mean_squared_error
from sklearn.model_selection import train_test_split
```

```{python}
# Step 1: Load Week 5 Data
data_path = "C:/Users/HP/Desktop/Python Project/data/pricing/Pricing_Model_Output.csv"
if not os.path.exists(data_path):
    raise FileNotFoundError("❌ Pricing_Model_Output.csv not found. Complete Week 5 first.")

data = pd.read_csv(data_path)
print("✅ Week 5 pricing data loaded.")
```

```{python}
# Step 2: Prepare data
data["Gender"] = data["Gender"].astype("category")
data["Region"] = data["Region"].astype("category")
```

```{python}
# Step 3: Encode categorical variables for XGBoost
X = pd.get_dummies(data[["Age", "Gender", "Region"]], drop_first=True)
y = data["Predicted_Premium"]
```

```{python}
# Step 4: Split train/test (80/20)
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=123)
```

```{python}
# Step 5: Train XGBoost model
xgb_model = xgb.XGBRegressor(
    objective="reg:squarederror",
    n_estimators=100,
    max_depth=6,
    learning_rate=0.1,
    verbosity=0
)
xgb_model.fit(X_train, y_train)
print("✅ XGBoost model trained.")
```

```{python}
# Step 6: Predict premiums on test set
y_pred = xgb_model.predict(X_test)
```

```{python}
# Step 7: Evaluate model
mae = mean_absolute_error(y_test, y_pred)
rmse = np.sqrt(mean_squared_error(y_test, y_pred))

print("\nXGBoost Model Evaluation:")
print("MAE:", round(mae, 2))
print("RMSE:", round(rmse, 2))
```

```{python}
# Step 8: Save model and predictions
os.makedirs("models", exist_ok=True)
os.makedirs("data/ml", exist_ok=True)

xgb_model.save_model("C:/Users/HP/Desktop/Python Project/reports/Week6_XGBoost_Model.json")

xgb_results = pd.DataFrame({
    "Actual_Premium": y_test,
    "Predicted_Premium": y_pred
})
xgb_results.to_csv("C:/Users/HP/Desktop/Python Project/data/ml/Week6_XGBoost_Predictions.csv", index=False)
```

```{python}
# Step 9: Plot predicted vs actual
os.makedirs("reports", exist_ok=True)

plt.figure(figsize=(6, 4))
sns.scatterplot(x="Actual_Premium", y="Predicted_Premium", data=xgb_results, color="darkgreen")
plt.plot([y_test.min(), y_test.max()], [y_test.min(), y_test.max()], 'r--')
plt.title("XGBoost: Predicted vs Actual Premiums")
plt.tight_layout()
plt.savefig("C:/Users/HP/Desktop/Python Project/reports/Week6_XGBoost_Predicted_vs_Actual.png")
plt.close()
```

```{python}
# Step 10: Generate report
report_text = f"""
WEEK 6: MODERN PRICING WITH XGBOOST
==================================

Model Evaluation:
MAE: {round(mae, 2)}
RMSE: {round(rmse, 2)}

Outputs:
- data/ml/Week6_XGBoost_Predictions.csv
- models/Week6_XGBoost_Model.json
- reports/Week6_XGBoost_Predicted_vs_Actual.png
"""

with open("C:/Users/HP/Desktop/Python Project/reports/Week6_XGBoost_Report.txt", "w") as f:
    f.write(report_text)

print("\n Week 6 (XGBoost) completed successfully! Report saved to reports/Week6_XGBoost_Report.txt")
```







